"""
ì±—ë´‡ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ - ë¶„ì„ ë° ê°œì„ 

ğŸ“– ê³µì‹ ë¬¸ì„œ: https://platform.openai.com/docs/guides/prompt-engineering
ğŸ”— ì°¸ê³ : OpenAI Best Practices for Prompting

ì‚¬ìš©ìì˜ ì¶•êµ¬ ì§ˆë¬¸ì— ëŒ€í•´ ì •í™•í•˜ê³  ì¹œì ˆí•˜ê²Œ ë‹µë³€í•˜ëŠ” ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
"""

# ============================================
# 1. ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (System Prompt)
# ============================================

SYSTEM_PROMPT = """ë‹¹ì‹ ì€ ì „ë¬¸ì ì´ê³  ì¹œì ˆí•œ ì¶•êµ¬ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.

ì—­í• :
- ì¶•êµ¬ ê²½ê¸°, íŒ€, ì„ ìˆ˜ì— ëŒ€í•œ ì§ˆë¬¸ì— ì •í™•í•˜ê²Œ ë‹µë³€
- ìµœì‹  ê²½ê¸° ê²°ê³¼, ìˆœìœ„í‘œ, ì„ ìˆ˜ í†µê³„ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì •ë³´ ì œê³µ
- ì¶•êµ¬ ë¶„ì„ì„ ì œê³µí•  ë•Œ ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ì„¤ëª…

ê·œì¹™:
1. í•œêµ­ì–´ë¡œ ë‹µë³€í•©ë‹ˆë‹¤
2. í•­ìƒ ì¶œì²˜ë¥¼ ëª…ì‹œí•©ë‹ˆë‹¤ (ê²½ê¸° ID, ë‚ ì§œ ë“±)
3. ë¶ˆí™•ì‹¤í•œ ì •ë³´ëŠ” "í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤"ë¼ê³  ëª…ì‹œ
4. ì¹œê·¼í•˜ê³  ìºì£¼ì–¼í•œ í†¤ ìœ ì§€
5. í•„ìš”ì‹œ ì´ëª¨ì§€ë¥¼ ì ì ˆíˆ ì‚¬ìš©
6. ê¸´ ë‹µë³€ì€ êµ¬ì¡°í™”ëœ í¬ë§·ìœ¼ë¡œ ì œì‹œ (ì œëª©, ë¦¬ìŠ¤íŠ¸ ë“±)

ì§ˆë¬¸ ë¶„ë¥˜:
- ì„ ìˆ˜ í¼: "ì†í¥ë¯¼ ìµœê·¼ í¼", "í™€ë€ë“œ ì‹œì¦Œ í†µê³„"
- íŒ€ ë¶„ì„: "ë§¨ì‹œí‹° ì´ë²ˆ ì‹œì¦Œ", "í† íŠ¸ë„˜ ìµœê·¼ 5ê²½ê¸°"
- ê²½ê¸° ë¹„êµ: "ë§¨ì‹œí‹° vs ì²¼ì‹œ", "ë¦¬ë²„í’€ vs ë§¨ìœ "
- ìˆœìœ„/í†µê³„: "í”„ë¦¬ë¯¸ì–´ë¦¬ê·¸ ìˆœìœ„", "ë¼ë¦¬ê°€ ë“ì ì™•"

ì‘ë‹µ í¬ë§·:
- ì§ì ‘ì ì¸ ë‹µë³€ ë¨¼ì €
- í•„ìš”ì‹œ ì¶”ê°€ ì •ë³´ (í†µê³„, ë¹„êµ ë“±)
- ë§ˆì§€ë§‰ì— ì¶œì²˜/ë°ì´í„° ëª…ì‹œ
"""

# ì±—ë´‡ì—ì„œ ì‚¬ìš©í•  ê¸°ë³¸ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
CHAT_SYSTEM_PROMPT = SYSTEM_PROMPT

# ============================================
# 2. ì„¸ë¶€ ë¶„ì„ í”„ë¡¬í”„íŠ¸
# ============================================

PLAYER_FORM_PROMPT = """ë‹¤ìŒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì„ ìˆ˜ì˜ ìµœê·¼ í¼ì„ ë¶„ì„í•´ì£¼ì„¸ìš”.

ì„ ìˆ˜ëª…: {player_name}
ì†Œì†íŒ€: {team}
í¬ì§€ì…˜: {position}

ìµœê·¼ ê²½ê¸° í†µê³„:
{stats}

ë¶„ì„ í¬ì¸íŠ¸:
1. ìµœê·¼ ê³¨/ë„ì›€ ì¶”ì´
2. ì¶œì „ ì‹œê°„ ë³€í™”
3. ê²½ê¸°ë ¥ í‰ê°€
4. í˜„ì¬ í¼ ìƒíƒœ (ì¢‹ìŒ/ë³´í†µ/ë¶€ì§„)

ì¹œê·¼í•œ í†¤ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ë‹µë³€í•´ì£¼ì„¸ìš”."""

TEAM_ANALYSIS_PROMPT = """ë‹¤ìŒ íŒ€ì˜ ì‹œì¦Œ ë¶„ì„ì„ í•´ì£¼ì„¸ìš”.

íŒ€ëª…: {team_name}
ë¦¬ê·¸: {league}
ì‹œì¦Œ: {season}

íŒ€ ë°ì´í„°:
- ìˆœìœ„: {position}
- ì „ì : {record} (ìŠ¹-ë¬´-íŒ¨)
- ê³¨ë“ì‹¤: {goal_diff}
- ìµœê·¼ 5ê²½ê¸°: {recent_matches}
- ì£¼ìš” ì„ ìˆ˜: {key_players}

ë¶„ì„í•´ì•¼ í•  ë¶€ë¶„:
1. ì‹œì¦Œ ì„±ì  í‰ê°€
2. ê°•ì ê³¼ ì•½ì 
3. ìµœê·¼ 5ê²½ê¸° íŠ¸ë Œë“œ
4. ìƒìœ„ê¶Œ ì§„ì¶œ ê°€ëŠ¥ì„± (ìˆë‹¤ë©´)

ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ê°ê´€ì ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”."""

MATCH_COMPARISON_PROMPT = """ë‘ íŒ€ì˜ ê²½ê¸°ë¥¼ ë¹„êµ ë¶„ì„í•´ì£¼ì„¸ìš”.

í™ˆ íŒ€: {home_team}
ì–´ì›¨ì´ íŒ€: {away_team}

íŒ€ë³„ ì •ë³´:
í™ˆ íŒ€:
- ìˆœìœ„: {home_position}
- ìµœê·¼ í¼: {home_form}
- ì£¼ìš” ì„ ìˆ˜: {home_players}

ì–´ì›¨ì´ íŒ€:
- ìˆœìœ„: {away_position}
- ìµœê·¼ í¼: {away_form}
- ì£¼ìš” ì„ ìˆ˜: {away_players}

ë¹„êµ í¬ì¸íŠ¸:
1. ì „ë ¥ ë¹„êµ
2. ìµœê·¼ ì§ì ‘ ëŒ€ë©´ ì „ì  (ìˆë‹¤ë©´)
3. ì˜ˆìƒë˜ëŠ” ê²½ê¸° ì–‘ìƒ
4. ì£¼ëª©í•  ì„ ìˆ˜ ë§¤ì¹˜ì—…

ê· í˜•ì¡íŒ ë¶„ì„ì„ ì œì‹œí•´ì£¼ì„¸ìš”."""

STATISTICS_PROMPT = """ë‹¤ìŒ í†µê³„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì„¤ëª…í•´ì£¼ì„¸ìš”.

í†µê³„ëª…: {stat_name}
ë°ì´í„°:
{data}

ì„¤ëª… í¬ì¸íŠ¸:
1. ìˆœìœ„ ìƒìœ„ê¶Œ ì„ ìˆ˜/íŒ€
2. ì£¼ëª©í•  ë§Œí•œ ì 
3. ì˜ì™¸ì˜ ê²°ê³¼ (ìˆë‹¤ë©´)

ê°„ê²°í•˜ê³  ì´í•´í•˜ê¸° ì‰½ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”."""

# ============================================
# 3. ì»¨í…ìŠ¤íŠ¸ ì¶”ê°€ í”„ë¡¬í”„íŠ¸
# ============================================

CONTEXT_INSTRUCTION = """ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ë‹µë³€í•´ì£¼ì„¸ìš”.

ì‚¬ìš©ì ì§ˆë¬¸: {user_query}

ì‘ë‹µ ê°€ì´ë“œ:
1. ì œê³µëœ ë°ì´í„°ë¥¼ ìµœëŒ€í•œ í™œìš©
2. ë§Œì•½ ë°ì´í„°ì— ì—†ëŠ” ë‚´ìš©ì´ë©´ "í•´ë‹¹ ì •ë³´ëŠ” ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"ë¼ê³  ëª…ì‹œ
3. í•­ìƒ ì¶œì²˜ì™€ ë‚ ì§œë¥¼ í¬í•¨
4. 3-5ë¬¸ì¥ìœ¼ë¡œ ê°„ê²°í•˜ê²Œ ì •ë¦¬

ì‘ë‹µ í¬ë§·:
[ì§ì ‘ì ì¸ ë‹µë³€]
ğŸ“Š ë°ì´í„°: [êµ¬ì²´ì  ìˆ˜ì¹˜/ì •ë³´]
ğŸ”— ì¶œì²˜: [ê²½ê¸° ID, ë‚ ì§œ ë“±]"""

# ============================================
# 4. ì—ëŸ¬/ì˜ˆì™¸ ì²˜ë¦¬ í”„ë¡¬í”„íŠ¸
# ============================================

NO_DATA_RESPONSE = """ì£„ì†¡í•˜ì§€ë§Œ, ìš”ì²­í•˜ì‹  ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

ê°€ëŠ¥í•œ ì´ìœ :
- ìµœê·¼ ê²½ê¸°ê°€ ì—†ìŒ
- ì„ ìˆ˜/íŒ€ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ
- ë°ì´í„°ê°€ ì—…ë°ì´íŠ¸ë˜ì§€ ì•ŠìŒ

ë‹¤ì‹œ ì‹œë„í•  ìˆ˜ ìˆëŠ” ë°©ë²•:
1. íŒ€/ì„ ìˆ˜ëª…ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”
2. ë‹¤ë¥¸ ê¸°ê°„ì˜ ì •ë³´ë¥¼ ìš”ì²­í•´ë³´ì„¸ìš”
3. ìµœê·¼ ê²½ê¸° ì •ë³´ë¥¼ ìš”ì²­í•´ë³´ì„¸ìš” (ì˜ˆ: "í”„ë¦¬ë¯¸ì–´ë¦¬ê·¸ ìµœê·¼ ê²½ê¸°")

ë„ì›€ì´ í•„ìš”í•˜ì‹ ê°€ìš”? ğŸ˜Š"""

CLARIFICATION_PROMPT = """ì§ˆë¬¸ì´ ëª¨í˜¸í•œ ê²ƒ ê°™ìŠµë‹ˆë‹¤. ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.

ì˜ˆë¥¼ ë“¤ì–´:
- ì„ ìˆ˜ í¼: "ì†í¥ë¯¼ ìµœê·¼ 5ê²½ê¸° í¼" ë˜ëŠ” "í™€ë€ë“œ ì´ë²ˆ ì‹œì¦Œ í†µê³„"
- íŒ€ ë¶„ì„: "ë§¨ì‹œí‹° ìˆœìœ„" ë˜ëŠ” "í† íŠ¸ë„˜ ìµœê·¼ ì „ì "
- ê²½ê¸° ë¹„êµ: "ë§¨ì‹œí‹° vs ì²¼ì‹œ ëˆ„ê°€ ë” ê°•í•œê°€"
- ìˆœìœ„í‘œ: "í”„ë¦¬ë¯¸ì–´ë¦¬ê·¸ í˜„ì¬ ìˆœìœ„" ë˜ëŠ” "ë¼ë¦¬ê°€ ìƒìœ„ 5íŒ€"

ë” êµ¬ì²´ì ìœ¼ë¡œ ë¬¼ì–´ë´ì£¼ì‹œë©´ ì •í™•í•˜ê²Œ ë‹µë³€ë“œë¦¬ê² ìŠµë‹ˆë‹¤! ğŸ‘"""

# ============================================
# 5. ìµœì¢… ì‘ë‹µ í¬ë§· í…œí”Œë¦¿
# ============================================

RESPONSE_FORMAT = """
**[ì œëª©]**

[ë‹µë³€ ë³¸ë¬¸ - 2-4ë¬¸ì¥]

ğŸ“Š **ì£¼ìš” ì •ë³´:**
- [í¬ì¸íŠ¸ 1]
- [í¬ì¸íŠ¸ 2]
- [í¬ì¸íŠ¸ 3]

ğŸ”— **ì¶œì²˜:**
- ë°ì´í„° ì¶œì²˜: Football-Data.org API
- ì¡°íšŒ ì‹œê°„: [ì‹œê°„]
- ê´€ë ¨ ê²½ê¸° ID: [IDë“¤]

ğŸ’¡ **íŒ:**
[ì¶”ê°€ ì •ë³´ ë˜ëŠ” ê´€ë ¨ ì§ˆë¬¸ ì œì‹œ]
"""

# ============================================
# 6. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
# ============================================


def get_system_prompt() -> str:
    """
    ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë°˜í™˜

    ğŸ“– ê³µì‹ ë¬¸ì„œ: https://platform.openai.com/docs/guides/prompt-engineering
    ğŸ”— ì°¸ê³ : System messages guide

    Returns:
        ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë¬¸ìì—´
    
    Example:
        >>> prompt = get_system_prompt()
        >>> print(prompt[:50])
        "ë‹¹ì‹ ì€ ì „ë¬¸ì ì´ê³  ì¹œì ˆí•œ ì¶•êµ¬ AI ì–´ì‹œìŠ¤í„´íŠ¸..."
    """
    return SYSTEM_PROMPT


def get_context_prompt(query: str, context_data: str) -> str:
    """
    ì»¨í…ìŠ¤íŠ¸ê°€ í¬í•¨ëœ í”„ë¡¬í”„íŠ¸ ìƒì„±

    ğŸ“– ê³µì‹ ë¬¸ì„œ: https://platform.openai.com/docs/guides/prompt-engineering/tactic-provide-context
    ğŸ”— ê¶Œì¥: Context documentsë¥¼ ë¨¼ì € ì œê³µ

    Args:
        query: ì‚¬ìš©ì ì§ˆë¬¸
        context_data: RAGì—ì„œ ê²€ìƒ‰ëœ ì»¨í…ìŠ¤íŠ¸

    Returns:
        ìƒì„±ëœ í”„ë¡¬í”„íŠ¸
    
    Example:
        >>> prompt = get_context_prompt(
        ...     "ì†í¥ë¯¼ í¼?",
        ...     "ì†í¥ë¯¼: ìµœê·¼ 5ê²½ê¸° 3ê³¨ 2ë„ì›€"
        ... )
    """
    return f"""ë‹¤ìŒ ì»¨í…ìŠ¤íŠ¸ë¥¼ ì°¸ê³ í•˜ì—¬ ì§ˆë¬¸ì— ë‹µë³€í•´ì£¼ì„¸ìš”.

ã€ì»¨í…ìŠ¤íŠ¸ã€‘
{context_data}

ã€ì‚¬ìš©ì ì§ˆë¬¸ã€‘
{query}

ìœ„ ì»¨í…ìŠ¤íŠ¸ë¥¼ ìµœëŒ€í•œ í™œìš©í•˜ì—¬ ì •í™•í•˜ê³  ì¹œì ˆí•˜ê²Œ ë‹µë³€í•´ì£¼ì„¸ìš”."""


def get_player_analysis_prompt(
    player_name: str, team: str, position: str, stats: str
) -> str:
    """
    ì„ ìˆ˜ ë¶„ì„ í”„ë¡¬í”„íŠ¸ ìƒì„±

    Args:
        player_name: ì„ ìˆ˜ëª…
        team: íŒ€ëª…
        position: í¬ì§€ì…˜
        stats: í†µê³„ ë°ì´í„°

    Returns:
        ìƒì„±ëœ í”„ë¡¬í”„íŠ¸
    
    Example:
        >>> prompt = get_player_analysis_prompt(
        ...     "ì†í¥ë¯¼", "í† íŠ¸ë„˜", "LW", "5ê²½ê¸° 3ê³¨ 2ë„ì›€"
        ... )
    """
    return PLAYER_FORM_PROMPT.format(
        player_name=player_name, team=team, position=position, stats=stats
    )


def get_team_analysis_prompt(
    team_name: str,
    league: str,
    season: str,
    position: int,
    record: str,
    goal_diff: str,
    recent_matches: str,
    key_players: str,
) -> str:
    """
    íŒ€ ë¶„ì„ í”„ë¡¬í”„íŠ¸ ìƒì„±

    Args:
        team_name: íŒ€ëª…
        league: ë¦¬ê·¸ëª…
        season: ì‹œì¦Œ
        position: í˜„ì¬ ìˆœìœ„
        record: ì „ì  (ìŠ¹-ë¬´-íŒ¨)
        goal_diff: ê³¨ë“ì‹¤
        recent_matches: ìµœê·¼ ê²½ê¸° ê²°ê³¼
        key_players: ì£¼ìš” ì„ ìˆ˜

    Returns:
        ìƒì„±ëœ í”„ë¡¬í”„íŠ¸
    """
    return TEAM_ANALYSIS_PROMPT.format(
        team_name=team_name,
        league=league,
        season=season,
        position=position,
        record=record,
        goal_diff=goal_diff,
        recent_matches=recent_matches,
        key_players=key_players,
    )


def get_match_comparison_prompt(
    home_team: str,
    away_team: str,
    home_position: int,
    away_position: int,
    home_form: str,
    away_form: str,
    home_players: str,
    away_players: str,
) -> str:
    """
    ê²½ê¸° ë¹„êµ ë¶„ì„ í”„ë¡¬í”„íŠ¸ ìƒì„±

    Args:
        home_team: í™ˆ íŒ€ëª…
        away_team: ì–´ì›¨ì´ íŒ€ëª…
        home_position: í™ˆ íŒ€ ìˆœìœ„
        away_position: ì–´ì›¨ì´ íŒ€ ìˆœìœ„
        home_form: í™ˆ íŒ€ ìµœê·¼ í¼
        away_form: ì–´ì›¨ì´ íŒ€ ìµœê·¼ í¼
        home_players: í™ˆ íŒ€ ì£¼ìš” ì„ ìˆ˜
        away_players: ì–´ì›¨ì´ íŒ€ ì£¼ìš” ì„ ìˆ˜

    Returns:
        ìƒì„±ëœ í”„ë¡¬í”„íŠ¸
    """
    return MATCH_COMPARISON_PROMPT.format(
        home_team=home_team,
        away_team=away_team,
        home_position=home_position,
        away_position=away_position,
        home_form=home_form,
        away_form=away_form,
        home_players=home_players,
        away_players=away_players,
    )


def format_chat_context(sources: list) -> str:
    """
    RAG ê²€ìƒ‰ ê²°ê³¼ë¥¼ í”„ë¡¬í”„íŠ¸ ì»¨í…ìŠ¤íŠ¸ë¡œ í¬ë§·íŒ…

    ğŸ“– ê³µì‹ ë¬¸ì„œ: https://platform.openai.com/docs/guides/prompt-engineering/tactic-provide-context
    ğŸ”— ê¶Œì¥: êµ¬ì¡°í™”ëœ í¬ë§·ìœ¼ë¡œ ì»¨í…ìŠ¤íŠ¸ ì œê³µ

    Args:
        sources: RAG ê²€ìƒ‰ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸
            [
                {
                    "id": "match_123",
                    "content": "Arsenal 3-1 Chelsea",
                    "metadata": {"team": "Arsenal", "date": "2024-10-17"},
                    "similarity": 0.95
                },
                ...
            ]

    Returns:
        í¬ë§·íŒ…ëœ ì»¨í…ìŠ¤íŠ¸ ë¬¸ìì—´
    
    Example:
        >>> sources = [{
        ...     "id": "match_1",
        ...     "content": "Arsenal 3-1 Chelsea",
        ...     "metadata": {"date": "2024-10-17"},
        ...     "similarity": 0.95
        ... }]
        >>> context = format_chat_context(sources)
        >>> print(context)
        "[ì¶œì²˜ 1]
         Arsenal 3-1 Chelsea
         ë©”íƒ€ë°ì´í„°: date: 2024-10-17, similarity: 0.95"
    """
    if not sources:
        return "í˜„ì¬ ì‚¬ìš© ê°€ëŠ¥í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."

    context_parts = []

    for i, source in enumerate(sources, 1):
        content = source.get("content", "")
        metadata = source.get("metadata", {})
        similarity = source.get("similarity", 0)

        part = f"[ì¶œì²˜ {i}]\n{content}"

        # ë©”íƒ€ë°ì´í„° ì¶”ê°€
        meta_items = []
        if metadata:
            for k, v in metadata.items():
                meta_items.append(f"{k}: {v}")
        
        if similarity > 0:
            meta_items.append(f"ìœ ì‚¬ë„: {similarity:.2%}")
        
        if meta_items:
            meta_str = ", ".join(meta_items)
            part += f"\në©”íƒ€ë°ì´í„°: {meta_str}"

        context_parts.append(part)

    return "\n\n".join(context_parts)